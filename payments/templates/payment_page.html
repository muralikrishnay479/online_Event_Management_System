{% extends 'layout/base.html' %}
{% load static %}

{% block title %}Payments{% endblock %}

{% block content %}
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
{% endif %}

<!-- Booking Details -->
<div class="card mb-4">
    <div class="card-header">
        <h5>Booking Details</h5>
    </div>
    <div class="card-body">
        <p><strong>Booking ID:</strong> {{ booking.id }}</p>
        <p><strong>Event Name:</strong> {{ booking.event_name }}</p>
        <p><strong>Event Date:</strong> {{ booking.event_date }}</p>
        <p><strong>Venue:</strong> {{ booking.venue }}</p>
        <p><strong>Total Cost:</strong> â‚¹{{ booking.total_cost }}</p>
    </div>
</div>

<!-- Payment Button -->
<button id="rzp-button1" class="btn btn-primary">Pay Now</button>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    var options = {
        "key": "{{ razorpay_merchant_key }}",
        "amount": "{{ razorpay_amount }}",
        "currency": "{{ currency }}",
        "name": "Event Booking System",
        "description": "Booking Payment",
        "order_id": "{{ razorpay_order_id }}",
        "handler": function (response) {
            var paymentData = {
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_order_id: response.razorpay_order_id,
                razorpay_signature: response.razorpay_signature,
                booking_id: "{{ booking_id }}"
            };

            var xhr = new XMLHttpRequest();
            xhr.open("POST", "{{ callback_url }}", true);
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            xhr.onload = function () {
                if (xhr.status === 200) {
                    window.location.href = "/payment_success/{{ booking_id }}/";
                } else {
                    window.location.href = "/payment_fail/";
                }
            };
            xhr.send(JSON.stringify(paymentData));
        },
        "prefill": {
            "name": "{{ user.username }}", 
            "email": "{{ user.email }}", 
            "contact": "9000090000" 
        },
        "notes": {
            "address": "Razorpay Corporate Office"
        },
        "theme": {
            "color": "#3399cc"
        }
    };

    var rzp1 = new Razorpay(options);

    document.getElementById('rzp-button1').onclick = function (e) {
        rzp1.open();
        e.preventDefault();
    };
</script>
{% endblock %}
